# 实现计划

- [x] 1. 创建核心数据模型和配置


  - 创建 `TransitionMode` 密封类定义所有过渡模式
  - 创建 `TransitionConfig` 数据类存储配置参数
  - 创建 `PageTransform` 数据类表示变换状态
  - 创建 `TransitionState` 数据类跟踪过渡状态
  - 创建 `EdgeSensitivity` 枚举定义灵敏度级别
  - 创建 `AnimationSpeed` 枚举定义动画速度
  - _需求: 1.1, 1.2, 7.1, 7.2, 7.3, 12.1, 12.2_





- [ ] 2. 实现 Slide 模式（最简单的过渡效果）
  - [ ] 2.1 创建 `TransitionAnimator` 接口定义动画计算方法
    - 定义 `calculateTransform(progress: Float)` 方法


    - 定义 `getShadowAlpha(progress: Float)` 方法
    - 定义 `getElevation(progress: Float)` 方法
    - _需求: 1.1, 9.2_
  
  - [x] 2.2 实现 `SlideAnimator` 类


    - 实现水平滑动变换计算
    - 实现垂直滑动变换计算（用于垂直阅读模式）
    - 添加可选的透明度渐变效果
    - 确保使用 GPU 加速属性（translationX/Y, alpha）
    - _需求: 1.1, 1.4, 9.1, 9.2_


  
  - [ ] 2.3 创建 `PageTransitionContainer` Composable
    - 使用 `BoxWithConstraints` 获取屏幕尺寸



    - 渲染当前页和下一页的 `Image` 组件
    - 应用 `graphicsLayer` 变换
    - 使用 `key()` 优化重组性能
    - _需求: 1.4, 9.1, 9.2_
  
  - [ ] 2.4 集成到 `ReaderScreen` 进行基础测试
    - 在 `ReaderScreen` 中添加 `PageTransitionContainer`
    - 实现简单的左右滑动触发过渡
    - 验证动画流畅度（目标 60fps）
    - _需求: 1.4, 9.3_

- [ ] 3. 实现手势处理系统
  - [ ] 3.1 创建 `PageGestureHandler` 类
    - 实现 `handleDragStart` 检测边缘滑动
    - 实现 `handleDrag` 计算拖动进度
    - 实现 `handleDragEnd` 判断完成条件
    - 支持速度检测（velocity）判断翻页意图
    - _需求: 5.1, 5.2, 5.3, 5.4, 7.2, 7.3, 7.4_
  
  - [ ] 3.2 在 `PageTransitionContainer` 中集成手势检测
    - 使用 `pointerInput` 添加拖动手势检测
    - 实时更新过渡进度
    - 处理多点触控取消（5.5）
    - 添加触觉反馈支持
    - _需求: 5.1, 5.4, 5.5, 8.4_


  
  - [ ] 3.3 实现点击区域翻页
    - 复用现有的 `TouchZoneDetector` 检测点击区域
    - 左侧点击触发上一页，右侧点击触发下一页
    - 点击时使用完整动画时长（不跟随手指）
    - 过渡期间忽略点击输入
    - _需求: 6.1, 6.2, 6.5_
  
  - [ ] 3.4 添加边缘灵敏度配置
    - 根据 `EdgeSensitivity` 计算有效触摸区域
    - 在设置中提供可视化指示器
    - 支持三个级别：Low (20%), Medium (40%), High (100%)
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 4. 实现 Overlay 模式
  - [ ] 4.1 创建 `OverlayAnimator` 类
    - 实现当前页的 translationX 变换
    - 下一页保持固定位置


    - 计算阴影透明度（0 到 0.4）
    - 添加 elevation 效果（4dp）
    - _需求: 2.1, 2.2, 2.3, 8.1, 8.2_
  
  - [ ] 4.2 实现阴影渲染
    - 使用 `drawBehind` 或 `graphicsLayer.shadowElevation`
    - 创建渐变阴影效果
    - 阴影强度随过渡进度变化
    - _需求: 2.3, 8.1, 8.2, 8.3_
  
  - [ ] 4.3 实现自动完成逻辑
    - 拖动超过 30% 时自动完成翻页
    - 小于 30% 时回弹到原页
    - 使用 `animateTo` 实现平滑过渡
    - _需求: 2.4, 2.5_

- [-] 5. 实现 Side-by-Side 模式


  - [ ] 5.1 创建 `SideBySideAnimator` 类
    - 计算当前页和下一页的并排位置
    - 两页同步移动
    - 添加分隔线阴影效果（2dp）
    - _需求: 3.1, 3.2, 3.3, 3.4_
  
  - [ ] 5.2 实现双页布局
    - 使用 `Row` 布局并排显示两页
    - 根据阅读方向调整页面顺序
    - 添加垂直分隔线
    - 过渡完成后只显示目标页


    - _需求: 3.1, 3.2, 3.5_
  
  - [ ] 5.3 优化双页预加载
    - 同时预加载当前页和下一页
    - 确保两页都在缓存中
    - _需求: 10.1, 10.2, 10.5_

- [ ] 6. 实现 Fade 模式
  - [ ] 6.1 创建 `FadeAnimator` 类
    - 当前页 alpha 从 1.0 到 0.0
    - 下一页 alpha 从 0.0 到 1.0
    - 使用 300ms 动画时长
    - _需求: 1.1, 12.5_
  
  - [ ] 6.2 实现交叉淡入淡出渲染
    - 使用 `Box` 叠加两页
    - 分别控制两页的 alpha 值
    - 确保 GPU 加速


    - _需求: 9.1, 9.2_

- [ ] 7. 实现 Curl 效果（高级功能）
  - [ ] 7.1 创建 `CurlAnimator` 类
    - 实现 rotationY 变换（0° 到 180°）
    - 使用三角函数计算卷曲偏移
    - 计算渐变阴影模拟光照

    - 实现背面亮度降低（50%）
    - _需求: 4.1, 4.2, 4.3, 8.4_
  
  - [ ] 7.2 实现实时卷曲跟随
    - 卷曲角度跟随触摸位置
    - 计算延迟 < 16ms
    - 90度时自动完成翻页
    - _需求: 4.1, 4.4, 4.5_
  
  - [ ] 7.3 优化卷曲性能
    - 预计算三角函数值
    - 限制渲染区域
    - 使用 GraphicsLayer 硬件加速
    - _需求: 9.1, 9.2, 9.3_

- [ ] 8. 创建 `PageTransitionController`
  - [ ] 8.1 实现过渡状态管理
    - 创建 `TransitionState` 状态流
    - 实现 `startTransition` 方法
    - 实现 `updateTransition` 方法
    - 实现 `completeTransition` 方法
    - 实现 `cancelTransition` 方法
    - _需求: 1.1, 1.2_
  
  - [ ] 8.2 集成动画器选择逻辑
    - 根据 `TransitionMode` 选择对应的 `Animator`
    - 支持运行时切换模式
    - 处理模式切换时的状态清理
    - _需求: 1.1, 1.2_
  
  - [ ] 8.3 实现页面预加载协调
    - 过渡开始时触发预加载
    - 根据模式预加载不同数量的页面
    - 与 `PagePreloader` 集成
    - _需求: 10.1, 10.2, 10.3, 10.4_
  
  - [ ] 8.4 添加性能监控
    - 记录每帧时间戳
    - 计算平均帧率
    - 检测低于 60fps 的情况
    - _需求: 9.3, 9.4_

- [ ] 9. 实现内存管理和优化
  - [ ] 9.1 创建 `TransitionMemoryManager`
    - 实现 `lockPages` 锁定过渡期间的页面
    - 实现 `unlockPages` 释放完成后的页面
    - 实现 `checkMemoryPressure` 检测内存压力
    - 与现有 `BitmapMemoryManager` 集成
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_
  
  - [ ] 9.2 实现页面资源释放
    - 过渡完成后立即释放旧页面
    - 500ms 内完成资源清理
    - 使用 bitmap 池复用内存
    - _需求: 11.1, 11.4, 11.5_
  
  - [ ] 9.3 实现内存压力响应
    - 可用内存 < 100MB 时清理缓存
    - 每 2 秒监控内存使用
    - 超过 80% 时触发 GC
    - _需求: 11.2, 11.3_

- [ ] 10. 实现性能监控和自动降级
  - [ ] 10.1 创建 `TransitionPerformanceMonitor`
    - 记录帧时间戳
    - 计算平均帧率


    - 检测低于 45fps 的情况
    - 生成性能报告
    - _需求: 9.3, 9.5_
  
  - [ ] 10.2 实现自动降级策略
    - 帧率 < 45fps 时禁用阴影效果


    - 内存不足时切换到 Fade 模式
    - Curl 模式在中端设备降级为 Slide
    - _需求: 9.5_
  


  - [ ] 10.3 添加性能日志
    - 记录每次过渡的性能指标
    - 输出缓存命中率
    - 输出内存使用报告
    - _需求: 9.3_


- [ ] 11. 扩展 ViewModel 和设置
  - [ ] 11.1 在 `ReaderViewModel` 中添加过渡设置
    - 创建 `PageTransitionSettings` 数据类

    - 添加 `transitionSettings` StateFlow
    - 实现 `updateTransitionMode` 方法
    - 实现 `updateAnimationSpeed` 方法
    - 实现 `updateEdgeSensitivity` 方法


    - _需求: 1.2, 12.1, 12.2_
  
  - [ ] 11.2 扩展 `AppSettings` 数据模型
    - 添加 `pageTransitionMode` 字段
    - 添加 `animationSpeed` 字段
    - 添加 `edgeSensitivity` 字段
    - 添加 `enableTransitionEffects` 字段
    - 添加 `enableTransitionHaptic` 字段
    - _需求: 1.2, 1.3, 8.5, 12.1, 12.2, 12.3_
  
  - [ ] 11.3 在 `SettingsViewModel` 中添加更新方法
    - 实现保存和加载过渡设置
    - 与 DataStore 集成
    - 确保设置持久化
    - _需求: 1.3_

- [ ] 12. 创建设置界面
  - [ ] 12.1 创建 `PageTransitionSettingsScreen` Composable
    - 显示所有过渡模式的列表
    - 每个模式显示预览动画
    - 支持选择和应用模式
    - _需求: 1.1, 1.5_
  
  - [ ] 12.2 实现动画速度选择器
    - 提供 Fast (200ms), Normal (300ms), Slow (500ms) 选项
    - 实时预览速度变化
    - _需求: 12.1, 12.2_
  
  - [ ] 12.3 实现边缘灵敏度配置
    - 提供 Low, Medium, High 三个选项
    - 显示可视化触摸区域指示器
    - _需求: 7.1, 7.2, 7.3, 7.5_
  
  - [ ] 12.4 添加视觉效果开关
    - 提供启用/禁用阴影效果的开关
    - 提供启用/禁用触觉反馈的开关
    - _需求: 8.5, 12.3_
  
  - [ ] 12.5 实现无障碍选项
    - 添加"减少动画"开关
    - 启用时强制使用 Fade 模式
    - 禁用所有视觉效果
    - _需求: 12.4, 12.5_

- [ ] 13. 实现视觉反馈增强
  - [ ] 13.1 实现阴影效果渲染
    - 使用 `drawBehind` 绘制渐变阴影
    - 阴影强度随进度变化（0.0 到 0.5）
    - 沿移动页面的前缘绘制
    - _需求: 8.1, 8.2_
  
  - [ ] 13.2 实现深度效果
    - 使用 Material 3 elevation 系统
    - 静止: 0dp, 拖动: 4dp, 卷曲: 8dp
    - _需求: 8.3_
  
  - [ ] 13.3 实现触觉反馈
    - 开始拖动时触发 LongPress 反馈
    - 完成翻页时触发 TextHandleMove 反馈
    - 支持配置启用/禁用
    - _需求: 8.4_
  
  - [ ] 13.4 添加视觉效果禁用选项
    - 提供设置项禁用所有效果
    - 用于偏好简洁动画的用户




    - _需求: 8.5_

- [ ] 14. 编写测试
  - [ ] 14.1 编写动画计算单元测试
    - 测试 `OverlayAnimator` 变换计算
    - 测试 `SideBySideAnimator` 变换计算
    - 测试 `CurlAnimator` 三角函数计算
    - 测试 `SlideAnimator` 和 `FadeAnimator`
    - _需求: 所有动画模式_
  
  - [ ] 14.2 编写手势处理单元测试
    - 测试边缘滑动检测
    - 测试拖动进度计算
    - 测试完成条件判断
    - 测试速度检测
    - _需求: 5.1, 5.2, 5.3, 5.4, 7.2, 7.3_
  
  - [ ] 14.3 编写性能测试
    - 测试帧率保持 60fps
    - 测试内存使用在限制内
    - 测试页面加载时间 < 100ms
    - _需求: 9.3, 10.1, 10.2_
  
  - [ ] 14.4 编写 UI 集成测试
    - 测试各种手势触发动画
    - 测试设置更改生效
    - 测试无障碍模式
    - _需求: 所有交互需求_

- [ ] 15. 集成和优化
  - [ ] 15.1 完整集成到 `ReaderScreen`
    - 替换现有的简单翻页逻辑
    - 确保与现有功能兼容（缩放、过滤器等）
    - 处理双页模式的特殊情况
    - _需求: 所有需求_
  
  - [ ] 15.2 性能优化和调试
    - 使用 Android Profiler 分析性能
    - 优化内存分配
    - 减少不必要的重组
    - _需求: 9.1, 9.2, 9.3, 9.4_
  
  - [ ] 15.3 添加错误处理
    - 处理页面加载失败
    - 处理内存不足异常
    - 实现优雅降级
    - _需求: 9.5, 11.2_
  
  - [ ] 15.4 文档和代码注释
    - 为所有公共 API 添加 KDoc
    - 添加使用示例
    - 创建性能优化指南
    - _需求: 所有需求_
