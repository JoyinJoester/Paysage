# Paysage 项目架构图

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          Paysage App                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        UI Layer (Compose)                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  MainActivity                                            │    │
│  │    └─ NavHost (Navigation)                              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ┌──────────────────┐         ┌──────────────────┐              │
│  │  LibraryScreen   │         │   ReaderScreen   │              │
│  │  - 书库列表       │────────▶│   - 阅读器界面    │              │
│  │  - 搜索功能       │         │   - 页面显示      │              │
│  │  - 扫描按钮       │         │   - 手势控制      │              │
│  └──────────────────┘         └──────────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                       ViewModel Layer                            │
│  ┌──────────────────┐         ┌──────────────────┐              │
│  │ LibraryViewModel │         │  ReaderViewModel │              │
│  │  - 书籍列表状态   │         │  - 当前书籍      │              │
│  │  - 搜索逻辑      │         │  - 阅读进度      │              │
│  │  - 扫描控制      │         │  - 书签管理      │              │
│  └──────────────────┘         └──────────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Repository Layer                            │
│  ┌─────────────────────────────────────────────────────┐        │
│  │  BookRepository                                      │        │
│  │   - 书籍 CRUD                                        │        │
│  │   - 文件扫描                                         │        │
│  │   - 封面生成                                         │        │
│  └─────────────────────────────────────────────────────┘        │
│                                                                   │
│  ┌────────────────────┐   ┌────────────────────────┐            │
│  │BookmarkRepository  │   │ReadingProgressRepo     │            │
│  │ - 书签管理         │   │ - 进度保存             │            │
│  └────────────────────┘   └────────────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Data Layer                               │
│                                                                   │
│  ┌─────────────────────────────────────────────────────┐        │
│  │            Room Database (PaysageDatabase)           │        │
│  │  ┌──────────┐ ┌──────────┐ ┌─────────────┐         │        │
│  │  │ BookDao  │ │Bookmark  │ │ReadingProgress│        │        │
│  │  │          │ │   Dao    │ │    Dao      │         │        │
│  │  └──────────┘ └──────────┘ └─────────────┘         │        │
│  │                                                      │        │
│  │  ┌─────┐  ┌────────┐  ┌──────────┐  ┌──────┐      │        │
│  │  │Book │  │Bookmark│  │Reading   │  │Cate- │      │        │
│  │  │     │  │        │  │Progress  │  │gory  │      │        │
│  │  └─────┘  └────────┘  └──────────┘  └──────┘      │        │
│  └─────────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Utility Layer                             │
│  ┌──────────────────┐         ┌──────────────────┐              │
│  │   FileParser     │         │   FileScanner    │              │
│  │  - PDF 解析      │         │  - 目录扫描      │              │
│  │  - ZIP 解压      │         │  - 文件过滤      │              │
│  │  - 图片提取      │         │  - 递归搜索      │              │
│  │  - 封面生成      │         │                  │              │
│  └──────────────────┘         └──────────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      File System / Storage                       │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐            │
│  │   /Download │  │  /Documents │  │  App Private │            │
│  │   目录      │  │   目录      │  │    目录      │            │
│  └─────────────┘  └─────────────┘  └──────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 数据流图

### 书籍扫描流程
```
用户点击扫描按钮
    │
    ▼
LibraryViewModel.scanBooks()
    │
    ▼
BookRepository.scanAndImportBooks()
    │
    ├─▶ FileScanner.scanDefaultDirectories()
    │       │
    │       └─▶ 递归扫描文件系统
    │               │
    │               └─▶ 过滤支持的格式
    │
    ├─▶ FileParser.getPageCount()
    │       │
    │       └─▶ 解析文件获取页数
    │
    └─▶ BookDao.insertBook()
            │
            └─▶ Room Database 保存
```

### 阅读器打开流程
```
用户点击书籍
    │
    ▼
导航到 ReaderScreen
    │
    ▼
ReaderViewModel.openBook(bookId)
    │
    ├─▶ BookRepository.getBookById()
    │       │
    │       └─▶ BookDao 查询
    │
    ├─▶ ReadingProgressRepository.getOrCreateProgress()
    │       │
    │       └─▶ 获取或创建阅读进度
    │
    └─▶ loadPage(pageNumber)
            │
            ├─▶ FileParser.extractPage()
            │       │
            │       ├─▶ PDF: PdfRenderer
            │       └─▶ ZIP: ZipFile
            │
            └─▶ 显示页面 Bitmap
```

### 书签管理流程
```
用户点击书签按钮
    │
    ▼
ReaderViewModel.toggleBookmark()
    │
    ▼
BookmarkRepository.toggleBookmark()
    │
    ├─▶ 检查当前页是否有书签
    │       │
    │       └─▶ BookmarkDao.getBookmarkByPage()
    │
    └─▶ 添加或删除书签
            │
            ├─▶ 添加: BookmarkDao.insertBookmark()
            └─▶ 删除: BookmarkDao.deleteBookmark()
```

## 🔄 状态管理

### LibraryViewModel 状态
```kotlin
data class LibraryUiState(
    isScanning: Boolean,          // 正在扫描
    scanResult: ScanResult?,      // 扫描结果
    scanError: String?,           // 扫描错误
    isGeneratingCovers: Boolean,  // 正在生成封面
    message: String?              // 提示消息
)
```

### ReaderViewModel 状态
```kotlin
data class ReaderUiState(
    isLoading: Boolean,           // 正在加载书籍
    isLoadingPage: Boolean,       // 正在加载页面
    currentPage: Int,             // 当前页码
    isUiVisible: Boolean,         // UI 是否可见
    error: String?,               // 错误消息
    message: String?              // 提示消息
)
```

## 📦 依赖关系

```
┌─────────────────────────────────────────┐
│         External Dependencies           │
├─────────────────────────────────────────┤
│ • Jetpack Compose (UI)                  │
│ • Room (Database)                       │
│ • Navigation Compose                    │
│ • Kotlin Coroutines                     │
│ • Coil (Image Loading)                  │
│ • Accompanist (Permissions)             │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│         Application Modules             │
├─────────────────────────────────────────┤
│ UI ──▶ ViewModel ──▶ Repository ──▶ Data│
│  │                        │         │    │
│  └────────────────────────┼─────────┘    │
│                           │              │
│                      Utils/Tools         │
└─────────────────────────────────────────┘
```

## 🎯 功能模块

### 核心功能模块
```
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│  书库管理     │   │   阅读器     │   │   设置管理    │
│              │   │              │   │              │
│ • 书籍列表    │   │ • 页面渲染   │   │ • 主题设置   │
│ • 搜索功能    │   │ • 翻页控制   │   │ • 阅读设置   │
│ • 分类管理    │   │ • 缩放平移   │   │ • 缓存管理   │
│ • 收藏功能    │   │ • 书签管理   │   │ • 关于信息   │
└──────────────┘   └──────────────┘   └──────────────┘
```

## 📱 屏幕流程

```
┌──────────────┐
│ SplashScreen │
└──────┬───────┘
       │
       ▼
┌──────────────┐     ┌──────────────┐
│LibraryScreen │────▶│ ReaderScreen │
│  (书库)      │◀────│  (阅读器)    │
└──────┬───────┘     └──────────────┘
       │
       │
       ▼
┌──────────────┐
│SettingsScreen│
│  (设置)      │
└──────────────┘
```

---

**文档版本**: 1.0  
**创建日期**: 2025-10-25  
**维护者**: Paysage Team
